radio = require('radio')
$ = require('jquery')

@CAAT.DEBUG = true

exports class GameRenderer
  SCENE_OFFSET:
    x: 0
    y: 0

  CANVAS_DIMENSIONS =
    minimum:
      width: 960
      height: 640

  constructor: (@game) ->
    self = @

    win = $(window)
    windowWidth = win.width()
    windowWidth = CANVAS_DIMENSIONS.minimum.width if windowWidth < CANVAS_DIMENSIONS.minimum.width
    windowHeight = win.height() - 50
    windowHeight = CANVAS_DIMENSIONS.minimum.height if windowHeight < CANVAS_DIMENSIONS.minimum.height

    CANVAS_DIMENSIONS =
      width: windowWidth
      height: windowHeight

    CAAT.Module.Initialization.TemplateWithSplash.init(
      CANVAS_DIMENSIONS.width, CANVAS_DIMENSIONS.height,

      # and will be added to the end of document. set an id of a canvas or div element
      'game',

      # keep splash at least this 2000 milliseconds
      <%= ENV['RACK_ENV'] == 'production' ? 2000 : 500 %>,

      # load these images and set them up for non splash scenes.
      # image elements must be of the form:
      # {id:'<unique string id>',    url:'<url to image>'}
      # No images can be set too.
      [],

      # onEndSplash callback function.
      # Create your scenes on this method.
      (director) ->
        div = $('#game')
        div.css('margin-left': "#{-0.5 * div.width()}px", 'margin-top': "#{-0.5 * div.height()}px")

        self.preloader = new CAAT.Module.Preloader.Preloader()

        self.director = director

        # create an offset adjusting container
        scene = director.createScene()
        container = new CAAT.Foundation.ActorContainer()
        scene.addChild(container)
        scene.setFillStyle('white')
        container.setSize(scene.width, scene.height)
        # nobody knows where that 32x32 offset is coming from but we need to correct it
        container.setLocation(self.SCENE_OFFSET.x, self.SCENE_OFFSET.y)
        # set the container as a fake scene
        self.scene = container

        self.mapContainer = new CAAT.Foundation.ActorContainer().
            setSize(CANVAS_DIMENSIONS.width, CANVAS_DIMENSIONS.height).
            setClip(true)
        container.addChild(self.mapContainer)
        self.mapContainer.centerAt(CANVAS_DIMENSIONS.width / 2, CANVAS_DIMENSIONS.height / 2)

        self.renderers = {}
        MapRenderer  = require('MapRenderer')
        self.renderers.map = new MapRenderer(self.game, self, self.mapContainer)
        UnitRenderer  = require('UnitRenderer')
        self.renderers.unit = new UnitRenderer(self.game, self, self.mapContainer)

        InputController  = require('InputController')
        self.inputController = new InputController(self, self.mapContainer)

        ScrollHandler = require('ScrollHandler')
        self.scrollHandler = new ScrollHandler(self.renderers.map)

        UIRenderer  = require('UIRenderer')
        self.renderers.ui = new UIRenderer(self.game, self)

        self.preloader.load (images) ->
          director.setImagesCache(images)
          radio("ew/renderer/assets-loaded").broadcast(self, images)

        inputEnabledRenderers = [
          self.renderers.unit
          self.renderers.map
        ]

        radio("ew/input/click").subscribe (e) ->
          for renderer in inputEnabledRenderers
            return unless renderer.click(e)

        CAAT.loop()
      ,

      # use this image as splash. It wi ll cover all of director's area. optional.
      "/assets/splash.png"
    )

