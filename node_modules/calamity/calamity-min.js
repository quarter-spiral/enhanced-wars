/*! Calamity 0.5.0-rc.5 - MIT license */
(function(){"undefined"==typeof _&&"function"==typeof require&&(_=require("underscore"));var t={version:"0.5.0-rc.5"},r=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.C=t):"function"==typeof define&&define.amd?define(["calamity"],t):r.Calamity=t;var i,s,e;i=t.EmitterMixin=function(){function t(){}return t.prototype.on=function(t,r,i){return i||(i=this),s(this).subscribe(t,r,i)},t.prototype.off=function(t,r,i){return e(this)?(i||(i=this),s(this).unsubscribe(t,r,i)):void 0},t.prototype.trigger=function(t,r,i){return e(this)?s(this).publish(t,r,i):void 0},t}(),e=function(t){return t._calamity?t._calamity.emitter?t._calamity.emitter.bus?!0:!1:!1:!1},s=function(t){var r,i;return r=t._calamity||(t._calamity={}),i=r.emitter||(r.emitter={}),i.bus||(i.bus=new o)},t.emitter=function(t){return _.extend(t,i.prototype)};var n;n=t.EventBridge=function(){function r(){}return t.emitter(r.prototype),r}();var o;o=t.EventBus=function(){function t(){this.id=g.genId(),this._subscriptions={},this._bridges=[]}return t.prototype.subscribe=function(t,r,i){var s;return this._subscriptions[t]||(this._subscriptions[t]=[]),s=new d(t,r,i,this),this._subscriptions[t].push(s),this._bridgeProp("subscribe",{subscription:s}),s},t.prototype.unsubscribe=function(t,r){var i,s,e,n,o,u,a,p,c;if(e=t,e instanceof d){if(t=e.address,!this._subscriptions[t])return;for(p=this._subscriptions[t],i=n=0,u=p.length;u>n;i=++n)s=p[i],s===e&&this._subscriptions[t].splice(i)}else{if(!this._subscriptions[t])return;for(c=this._subscriptions[t],i=o=0,a=c.length;a>o;i=++o)s=c[i],s.address===t&&s.handler===r&&(e=s,this._subscriptions[t].splice(i))}this._bridgeProp("unsubscribe",{subscription:e})},t.prototype.publish=function(t,r,i){var s;return s=this._createMessage(t,r,i),t=s.address,s.sawBus(this)?this:(s.addBus(this),this._publishAddress(t,s),this._publishAddress("*",s),this._bridgeProp("publish",{message:s}),this)},t.prototype.send=function(t,r,i){var s;return s=this._createMessage(t,r,i),t=s.address,s.sawBus(this)?this:(s.addBus(this),this._sendAddress(t,s),this._bridgeProp("send",{message:s}),this)},t.prototype.bridge=function(t){if(!(t instanceof n))throw Error("Briges must extend Calamity.EventBridge");return _.contains(this._bridges,t)||this._bridges.push(t),this},t.prototype._createMessage=function(t,r,i){var s;return s=t,s instanceof u||(s=new u(t,r,i)),s},t.prototype._publishAddress=function(t,r){var i,s,e,n;if(this._subscriptions[t])for(n=this._subscriptions[t],s=0,e=n.length;e>s;s++)i=n[s],i.trigger(r)},t.prototype._sendAddress=function(t,r){var i,s,e;this._subscriptions[t]&&(e=this._subscriptions[t],s=e.length,i=Math.floor(Math.random()*s),e[i].trigger(r))},t.prototype._bridgeProp=function(t,r){var i,s,e,n,o;if(this._bridges.length>0)for(i="bus."+t,r.bus=this,o=this._bridges,e=0,n=o.length;n>e;e++)s=o[e],s.trigger(i,r)},t}();var u;u=t.EventMessage=function(){function r(t,r,i){if(this.address=t,this.data=null!=r?r:{},this.id=g.genId(),this._busses=[],!_.isUndefined(i)&&!_.isFunction(i))throw Error("Reply must be a function");this._replyHandler=i,this.status="ok",this.error=null}return r.prototype.reply=function(t,i){var s;return s=this._replyHandler,_.isFunction(s)?(t instanceof r||(t=new r(null,t,i)),s(t),this):void 0},r.prototype.replyError=function(t,i){var s,e,n,o,u,a;if(null==i&&(i={}),t instanceof Error){for(a="message,name,stack,fileName,lineNumber,description,number".split(","),o=0,u=a.length;u>o;o++)e=a[o],n=t[e],n&&"function"==typeof n.toString&&(n=""+n),i[e]=n;"function"==typeof t.toString&&(i.string=""+t,t=i.string,i.stack&&(t+=" :: "+i.stack))}return s=new r(null,i),s.status="error",s.error=t,this.reply(s),this},r.prototype["catch"]=function(t,i){if(null==i){if(!_.isFunction(t))throw Error("Supplied handler is not a function, "+typeof t+" supplied");i=t,t=void 0}if(_.isFunction(this._replyHandler)){if(null!=t){if(!(t instanceof r))return t instanceof Error||(t=Error(t)),this.replyError(t),void 0;if(t.isError())return this.reply(t),void 0}try{i(t)}catch(s){this.replyError(s)}}else{if(null!=t){if(!(t instanceof r))throw t instanceof Error||(t=Error(t)),t;if(t.isError())throw t.error}i(t)}},r.prototype.isSuccess=function(){return"ok"===this.status},r.prototype.isError=function(){return"error"===this.status},r.prototype.getOptional=function(t,r){var i,s,e,n,o,u;if(s=t.split("."),e=this.data[s[0]],s.length>1)for(u=s.splice(1),n=0,o=u.length;o>n;n++){if(i=u[n],!_.isObject(e)||null==e[i]){e=void 0;break}e=e[i]}return e===void 0?r:e},r.prototype.getRequired=function(t){var r;if(r=this.getOptional(t),r===void 0)throw Error('Variable "'+t+'" not found on message with address "'+this.address+'"');return r},r.prototype.addBus=function(t){return this.sawBus(t)?this:(this._busses.push(t.id),this)},r.prototype.sawBus=function(t){return _.contains(this._busses,t.id)},r.prototype.toJSON=function(){var r;return r={calamity:t.version,address:this.address,data:this.data,status:this.status,error:this.error},null!=this._replyHandler&&(r.reply=_.bind(this.reply,this)),r},r.fromJSON=function(t){var i;if(!_.isObject(t))throw Error("JSON must be an object");if(null==t.calamity)throw Error("Serialized JSON is not for calamity: "+JSON.stringify(t));return i=new r(t.address,t.data,t.reply),i.status=t.status,i.error=t.error,i},r}();var a,p={}.hasOwnProperty,c=function(t,r){function i(){this.constructor=t}for(var s in r)p.call(r,s)&&(t[s]=r[s]);return i.prototype=r.prototype,t.prototype=new i,t.__super__=r.prototype,t};a=t.MemoryEventBridge=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return c(r,t),r.prototype.handler=function(t){var r,i,s,e;for(e=this._busses,i=0,s=e.length;s>i;i++)r=e[i],r.publish(t)},r}(n);var h,f;f=t.ProxyMixin=function(){function t(){}return t.prototype.subscribe=function(t,r){return this._calamity.proxy.bus.subscribe(t,r,this)},t.prototype.publish=function(t,r,i){return this._calamity.proxy.bus.publish(t,r,i)},t.prototype.send=function(t,r,i){return this._calamity.proxy.bus.send(t,r,i)},t}(),h=null,t.global=function(){return h||(h=new o),h},t.proxy=function(r,i){var s;return i instanceof o||(i=t.global()),s=r._calamity||(r._calamity={}),s.proxy={bus:i},_.extend(r,f.prototype)};var d;d=t.Subscription=function(){function t(t,r,i,s){this.address=t,this.handler=r,this.context=i,this.bus=s,this.id=g.genId(),this.active=!0}return t.prototype.unsubscribe=function(){return this.active?(this.bus.unsubscribe(this),this.active=!1,this):void 0},t.prototype.trigger=function(t){var r;return this.active?(r=_.bind(this.handler,this.context),r(t),this):this},t}();var l,b,y,g;y=Math.random,b=Math.floor,l="0123456789abcdef".split(""),g=t.util={genId:function(){var t,r,i;for(r="",t=i=1;32>=i;t=++i)r+=l[b(y()*l.length)];return r}}}).call(this);